

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Lab 4: Exception and Interrupt &mdash; nycuos 0.0 documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="The Assembly You Need" href="../hardware/asm.html" />
    <link rel="prev" title="Lab 3: Allocator" href="lab3.html" />
 
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-QNCCQQWJ9J"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-QNCCQQWJ9J');
</script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> nycuos
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Labs</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="lab0.html">Lab 0: Environment Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="lab1.html">Lab 1: Hello World</a></li>
<li class="toctree-l1"><a class="reference internal" href="lab2.html">Lab 2: Booting</a></li>
<li class="toctree-l1"><a class="reference internal" href="lab3.html">Lab 3: Allocator</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Lab 4: Exception and Interrupt</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#introduction">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="#goals-of-this-lab">Goals of this lab</a></li>
<li class="toctree-l2"><a class="reference internal" href="#background">Background</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#official-reference">Official Reference</a></li>
<li class="toctree-l3"><a class="reference internal" href="#exception-levels">Exception Levels</a></li>
<li class="toctree-l3"><a class="reference internal" href="#exception-handling">Exception Handling</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#vector-table">Vector Table</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#interrupts">Interrupts</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#interrupt-controllers">Interrupt Controllers</a></li>
<li class="toctree-l4"><a class="reference internal" href="#critical-sections">Critical Sections</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#required">Required</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#requirement-1">Requirement 1</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#exception-level-switch">Exception Level Switch</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id2">Exception Handling</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#requirement-2">Requirement 2</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#core-timer-interrupt">Core Timer Interrupt</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#elective">Elective</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#enable-interrupt-in-el1">Enable Interrupt in EL1</a></li>
<li class="toctree-l3"><a class="reference internal" href="#rpi3-s-peripheral-interrupt">Rpi3’s Peripheral Interrupt</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#enable-mini-uart-s-interrupt">Enable mini UART’s Interrupt.</a></li>
<li class="toctree-l4"><a class="reference internal" href="#determine-the-interrupt-source">Determine the Interrupt Source</a></li>
<li class="toctree-l4"><a class="reference internal" href="#asynchronous-read-and-write">Asynchronous Read and Write</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#timer-multiplexing">Timer Multiplexing</a></li>
<li class="toctree-l3"><a class="reference internal" href="#concurrent-i-o-devices-handling">Concurrent I/O Devices Handling</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#decouple-the-interrupt-handlers">Decouple the Interrupt Handlers</a></li>
<li class="toctree-l4"><a class="reference internal" href="#nested-interrupt">Nested Interrupt</a></li>
<li class="toctree-l4"><a class="reference internal" href="#preemption">Preemption</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Hardware</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../hardware/asm.html">The Assembly You Need</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hardware/uart.html">UART</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hardware/mailbox.html">Mailbox</a></li>
</ul>
<p class="caption"><span class="caption-text">Miscs</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../external_reference/index.html">External Reference</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">nycuos</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Lab 4: Exception and Interrupt</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/labs/lab4.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="lab-4-exception-and-interrupt">
<h1>Lab 4: Exception and Interrupt<a class="headerlink" href="#lab-4-exception-and-interrupt" title="Permalink to this headline">¶</a></h1>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>An exception is an event that causes the currently executing program to relinquish the CPU to the corresponding handler.
With the exception mechanism, an operating system can</p>
<ol class="arabic simple">
<li><p>do proper handling when an error occurs during execution.</p></li>
<li><p>A user program can generate an exception to get the corresponding operating system’s service.</p></li>
<li><p>A peripheral device can force the currently executing program to relinquish the CPU and execute its handler.</p></li>
</ol>
</div>
<div class="section" id="goals-of-this-lab">
<h2>Goals of this lab<a class="headerlink" href="#goals-of-this-lab" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Understand what’s exception levels in Armv8-A.</p></li>
<li><p>Understand what’s exception handling.</p></li>
<li><p>Understand what’s interrupt.</p></li>
<li><p>Understand how rpi3’s peripherals interrupt the CPU by interrupt controllers.</p></li>
<li><p>Understand how to multiplex a timer.</p></li>
<li><p>Understand how to concurrently handle I/O devices.</p></li>
</ul>
</div>
<div class="section" id="background">
<h2>Background<a class="headerlink" href="#background" title="Permalink to this headline">¶</a></h2>
<div class="section" id="official-reference">
<h3>Official Reference<a class="headerlink" href="#official-reference" title="Permalink to this headline">¶</a></h3>
<p>Exceptions are tightly coupled with the CPU’s design.
We only briefly introduce the components needed in this lab.
If you want to know the details, please refer to ARM’s official
<a class="reference external" href="https://developer.arm.com/documentation/102412/0100">introduction</a>
and
<a class="reference external" href="https://developer.arm.com/documentation/ddi0487/aa/?lang=en">manual</a>’s Chapter D1(page 1496)</p>
</div>
<div class="section" id="exception-levels">
<h3>Exception Levels<a class="headerlink" href="#exception-levels" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="https://en.wikipedia.org/wiki/Principle_of_least_privilege">Principle of least privilege</a>
limits the resource that a program can access.
The limitation reduces possible errors during execution and the attack surface,
so the system’s security and stability are increased.
Armv8-A’s CPUs follow the principle and implement exception levels,
so an operating system can run diverse user applications without crashing the entire system.</p>
<img alt="../_images/exception_levels.jpg" src="../_images/exception_levels.jpg" />
<p>Armv8-A has 4 exception levels(ELs).
In general, all user programs are run in EL0, and operating systems are run in EL1.
The operating system can decrease the exception level and jump to the user program by setting the system registers and execute an exception return instruction.
When an exception is taken during a user program’s execution, the exception level is increased, and the CPU will jump to the exception handler.</p>
</div>
<div class="section" id="exception-handling">
<h3>Exception Handling<a class="headerlink" href="#exception-handling" title="Permalink to this headline">¶</a></h3>
<p>When a CPU takes an exception, it does the following things.</p>
<ul class="simple">
<li><p>Save the current processor’s state(PSTATE) in SPSR_ELx. (x is the target Exception level)</p></li>
<li><p>Save the exception return address in ELR_ELx.</p></li>
<li><p>Disable its interrupt. (PSTATE.{D,A,I,F} are set to 1).</p></li>
<li><p>If the exception is a synchronous exception or an an SError interrupt, save the cause of that exception in ESR_ELx.</p></li>
<li><p>Switch to the target Exception level and start at the corresponding vector address.</p></li>
</ul>
<p>After the exception handler finishes, it issues <code class="docutils literal notranslate"><span class="pre">eret</span></code> to return from the exception.
Then the CPU,</p>
<ul class="simple">
<li><p>Restore program counter from ELR_ELx.</p></li>
<li><p>Restore PSTATE from SPSR_ELx.</p></li>
<li><p>Switch to the corresponding Exception level according to SPSR_ELx.</p></li>
</ul>
<div class="section" id="vector-table">
<h4>Vector Table<a class="headerlink" href="#vector-table" title="Permalink to this headline">¶</a></h4>
<p>As mentioned above, the CPU starts its execution at the corresponding vector address.
The address is defined as the following vector table, and the base address of the table is saved in VBAR_ELx.</p>
<img alt="../_images/vector_table.jpg" src="../_images/vector_table.jpg" />
<p>The left part of the table is the cause of an exception.
In this lab, we only focus on Synchronous and IRQ exceptions.
The right part of the table is the relationship between the EL that the exception happens and the EL that it targets.
In this lab, we only focus on the case that the kernel takes exceptions(EL1 -&gt; EL1) and 64bit user programs take exceptions(EL0 -&gt; EL1).
Also, we want the kernel and user programs using different stacks(use SP_ELx).
Therefore, it corresponds to the table’s</p>
<blockquote>
<div><p>Exception from the currentEL while using SP_ELx</p>
</div></blockquote>
<p>and</p>
<blockquote>
<div><p>Exception from a lower EL and at least one lower EL is AARCH64.</p>
</div></blockquote>
</div>
</div>
<div class="section" id="interrupts">
<h3>Interrupts<a class="headerlink" href="#interrupts" title="Permalink to this headline">¶</a></h3>
<p>Besides computing, the CPU also needs to control I/O devices.
I/O devices are not always ready.
Hence, the CPU needs to check the device’s status and readiness before processing an I/O device’s data.</p>
<p>In previous labs, you did it by busy polling the devices.
However, redundant polling wastes CPU time.
Also, the CPU may not handle an I/O device’s data immediately right after the device is ready.
It may lead to the I/O device’s underutilization or data loss.</p>
<p>Interrupts as an alternative way allow I/O devices to inform the CPU when they’re ready.
Then, the CPU can do the device’s handler to process the data immediately.
Besides, interrupt forces the current running process relinquishes the CPU’s control.
Therefore, any process can’t run with indefinite time.</p>
<div class="section" id="interrupt-controllers">
<h4>Interrupt Controllers<a class="headerlink" href="#interrupt-controllers" title="Permalink to this headline">¶</a></h4>
<p>Rpi3 has two levels of interrupt controllers.
The first level controller routes interrupt to each CPU core, so each CPU core can have its own timer interrupt and send interrupt processor Interrupts between each other.
The details could be found in</p>
<p><a class="reference external" href="https://github.com/raspberrypi/documentation/blob/master/hardware/raspberrypi/bcm2836/QA7_rev3.4.pdf">https://github.com/raspberrypi/documentation/blob/master/hardware/raspberrypi/bcm2836/QA7_rev3.4.pdf</a></p>
<p>The second level controller routes interrupts from peripherals such as UART and system timer, they are aggregated and send to the first level interrupt controller as GPU IRQ.
The details could be found in</p>
<p><a class="reference external" href="https://cs140e.sergio.bz/docs/BCM2837-ARM-Peripherals.pdf">https://cs140e.sergio.bz/docs/BCM2837-ARM-Peripherals.pdf</a> (page 109)</p>
</div>
<div class="section" id="critical-sections">
<h4>Critical Sections<a class="headerlink" href="#critical-sections" title="Permalink to this headline">¶</a></h4>
<p>A critical section is a code segment that can’t be executed concurrently.
When interrupts are enabled, the CPU can be interrupted when it’s accessing some shared data.
If the interrupt handler also accesses the data, the data may be corrupted.
Therefore, the kernel needs to protect the shared data.</p>
<p>In the required part, interrupts are only enabled in user programs(EL0).
Hence, your kernel doesn’t need to handle it.</p>
<p>In the elective part, your kernel should enable interrupts.
Hence, you should either</p>
<ul class="simple">
<li><p>disable the CPU’s interrupt temporarily in critical sections to prevent concurrent access in the interrupt handlers.</p></li>
<li><p>limit interrupt handlers from calling part of the APIs that access the shared data.</p></li>
</ul>
</div>
</div>
</div>
<div class="section" id="required">
<h2>Required<a class="headerlink" href="#required" title="Permalink to this headline">¶</a></h2>
<div class="section" id="requirement-1">
<h3>Requirement 1<a class="headerlink" href="#requirement-1" title="Permalink to this headline">¶</a></h3>
<div class="section" id="exception-level-switch">
<h4>Exception Level Switch<a class="headerlink" href="#exception-level-switch" title="Permalink to this headline">¶</a></h4>
<div class="section" id="el2-to-el1">
<h5>EL2 to EL1<a class="headerlink" href="#el2-to-el1" title="Permalink to this headline">¶</a></h5>
<p>Rpi3’s CPU runs in EL2 after booted by default, but we want the kernel to run in EL1.
Hence, your kernel needs to switch to EL1 at the beginning.</p>
<p>You can use the following code to switch from EL2 to EL1.
It configures <code class="docutils literal notranslate"><span class="pre">hcr_el2</span></code>  so EL1 runs in AARCH64.
Then it sets <code class="docutils literal notranslate"><span class="pre">spsr_el2</span></code> and <code class="docutils literal notranslate"><span class="pre">elr_el2</span></code>, so the CPU can return to the target address with the correct PSTATE after <code class="docutils literal notranslate"><span class="pre">eret</span></code>.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span>    <span class="p">...</span>
    <span class="n">bl</span> <span class="n">from_el2_to_el1</span>
    <span class="cp"># the next instruction runs in EL1</span>
    <span class="p">...</span>
<span class="nl">from_el2_to_el1</span><span class="p">:</span>
    <span class="n">mov</span> <span class="n">x0</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">31</span><span class="p">)</span> <span class="c1">// EL1 uses aarch64</span>
    <span class="n">msr</span> <span class="n">hcr_el2</span><span class="p">,</span> <span class="n">x0</span>
    <span class="n">mov</span> <span class="n">x0</span><span class="p">,</span> <span class="mh">0x3c5</span> <span class="c1">// EL1h (SPSel = 1) with interrupt disabled</span>
    <span class="n">msr</span> <span class="n">spsr_el2</span><span class="p">,</span> <span class="n">x0</span>
    <span class="n">msr</span> <span class="n">elr_el2</span><span class="p">,</span> <span class="n">lr</span>
    <span class="n">eret</span> <span class="c1">// return to EL1</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">required</span> <span class="pre">1-1</span></code> Switch from EL2 to EL1 .</p>
</div>
<div class="section" id="el1-to-el0">
<h5>EL1 to EL0<a class="headerlink" href="#el1-to-el0" title="Permalink to this headline">¶</a></h5>
<p>After the kernel is initialized, it can load user programs and execute them in EL0 by <code class="docutils literal notranslate"><span class="pre">eret</span></code>.
You need to add a command to your shell that can</p>
<ol class="arabic simple">
<li><p>load a user program in the initramfs to a specific address.</p></li>
<li><p>set <code class="docutils literal notranslate"><span class="pre">spsr_el1</span></code> to <code class="docutils literal notranslate"><span class="pre">0x3c0</span></code> and <code class="docutils literal notranslate"><span class="pre">elr_el1</span></code> to the program’s start address.</p></li>
<li><p>set the user program’s stack pointer to a proper position by setting <code class="docutils literal notranslate"><span class="pre">sp_el0</span></code>.</p></li>
<li><p>issue <code class="docutils literal notranslate"><span class="pre">eret</span></code> to return to the user code.</p></li>
</ol>
<p><code class="docutils literal notranslate"><span class="pre">required</span> <span class="pre">1-2</span></code> Add a command that can load a user program in the initramfs. Then, use <code class="docutils literal notranslate"><span class="pre">eret</span></code> to jump to the start address.</p>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>You can use QEMU and GDB to check if you do it correctly.</p>
</div>
</div>
<div class="section" id="el0-to-el1">
<h5>EL0 to EL1<a class="headerlink" href="#el0-to-el1" title="Permalink to this headline">¶</a></h5>
<p>The user program can go back to EL1 by taking an exception.
But you need to set up the exception vector table first.
You can use the following vector table and set <code class="docutils literal notranslate"><span class="pre">vbar_el1</span></code> to its address.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="nl">exception_handler</span><span class="p">:</span>
  <span class="p">...</span>
<span class="p">.</span><span class="n">align</span> <span class="mi">11</span> <span class="c1">// vector table should be aligned to 0x800</span>
<span class="p">.</span><span class="n">global</span> <span class="n">exception_vector_table</span>
<span class="nl">exception_vector_table</span><span class="p">:</span>
  <span class="n">b</span> <span class="n">exception_handler</span> <span class="c1">// branch to a handler function.</span>
  <span class="p">.</span><span class="n">align</span> <span class="mi">7</span> <span class="c1">// entry size is 0x80, .align will pad 0</span>
  <span class="n">b</span> <span class="n">exception_handler</span>
  <span class="p">.</span><span class="n">align</span> <span class="mi">7</span>
  <span class="n">b</span> <span class="n">exception_handler</span>
  <span class="p">.</span><span class="n">align</span> <span class="mi">7</span>
  <span class="n">b</span> <span class="n">exception_handler</span>
  <span class="p">.</span><span class="n">align</span> <span class="mi">7</span>

  <span class="n">b</span> <span class="n">exception_handler</span>
  <span class="p">.</span><span class="n">align</span> <span class="mi">7</span>
  <span class="n">b</span> <span class="n">exception_handler</span>
  <span class="p">.</span><span class="n">align</span> <span class="mi">7</span>
  <span class="n">b</span> <span class="n">exception_handler</span>
  <span class="p">.</span><span class="n">align</span> <span class="mi">7</span>
  <span class="n">b</span> <span class="n">exception_handler</span>
  <span class="p">.</span><span class="n">align</span> <span class="mi">7</span>

  <span class="n">b</span> <span class="n">exception_handler</span>
  <span class="p">.</span><span class="n">align</span> <span class="mi">7</span>
  <span class="n">b</span> <span class="n">exception_handler</span>
  <span class="p">.</span><span class="n">align</span> <span class="mi">7</span>
  <span class="n">b</span> <span class="n">exception_handler</span>
  <span class="p">.</span><span class="n">align</span> <span class="mi">7</span>
  <span class="n">b</span> <span class="n">exception_handler</span>
  <span class="p">.</span><span class="n">align</span> <span class="mi">7</span>

  <span class="n">b</span> <span class="n">exception_handler</span>
  <span class="p">.</span><span class="n">align</span> <span class="mi">7</span>
  <span class="n">b</span> <span class="n">exception_handler</span>
  <span class="p">.</span><span class="n">align</span> <span class="mi">7</span>
  <span class="n">b</span> <span class="n">exception_handler</span>
  <span class="p">.</span><span class="n">align</span> <span class="mi">7</span>
  <span class="n">b</span> <span class="n">exception_handler</span>
  <span class="p">.</span><span class="n">align</span> <span class="mi">7</span>

<span class="nl">set_exception_vector_table</span><span class="p">:</span>
  <span class="n">adr</span> <span class="n">x0</span><span class="p">,</span> <span class="n">exception_vector_table</span>
  <span class="n">msr</span> <span class="n">vbar_el1</span><span class="p">,</span> <span class="n">x0</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The vector table’s base address should be aligned to 0x800</p>
</div>
</div>
</div>
<div class="section" id="id2">
<h4>Exception Handling<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h4>
<p>After setting the vector table, loads the following user program.
The user program takes an exception by the <code class="docutils literal notranslate"><span class="pre">svc</span></code> instruction which is used for system calls.</p>
<p>The design of system calls is left to the next lab.
Now, your kernel only needs to print the content of <code class="docutils literal notranslate"><span class="pre">spsr_el1</span></code>, <code class="docutils literal notranslate"><span class="pre">elr_el1</span></code>, and <code class="docutils literal notranslate"><span class="pre">esr_el1</span></code> in the exception handler.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="p">.</span><span class="n">section</span> <span class="s">&quot;.text&quot;</span>
<span class="p">.</span><span class="n">global</span> <span class="n">_start</span>
<span class="nl">_start</span><span class="p">:</span>
    <span class="n">mov</span> <span class="n">x0</span><span class="p">,</span> <span class="mi">0</span>
<span class="mi">1</span><span class="o">:</span>
    <span class="n">add</span> <span class="n">x0</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="mi">1</span>
    <span class="n">svc</span> <span class="mi">0</span>
    <span class="n">cmp</span> <span class="n">x0</span><span class="p">,</span> <span class="mi">5</span>
    <span class="n">blt</span> <span class="mi">1</span><span class="n">b</span>
<span class="mi">1</span><span class="o">:</span>
    <span class="n">b</span> <span class="mi">1</span><span class="n">b</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">required</span> <span class="pre">1-3</span></code> Set the vector table and implement the exception handler.</p>
<div class="section" id="context-saving">
<h5>Context saving<a class="headerlink" href="#context-saving" title="Permalink to this headline">¶</a></h5>
<p>You may find that the above user program behaves unexpectedly.
That’s because the user program and the exception handler share the same general purpose registers bank.
You need to save them before entering the kernel’s function.
Otherwise, it may be corrupted.</p>
<p>You can use the following code to save registers before entering the kernel and load them before exiting the kernel.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">// save general registers to stack</span>
<span class="p">.</span><span class="n">macro</span> <span class="n">save_all</span>
    <span class="n">sub</span> <span class="n">sp</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="mi">32</span> <span class="o">*</span> <span class="mi">8</span>
    <span class="n">stp</span> <span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span> <span class="p">,</span><span class="mi">16</span> <span class="o">*</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">stp</span> <span class="n">x2</span><span class="p">,</span> <span class="n">x3</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span> <span class="p">,</span><span class="mi">16</span> <span class="o">*</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">stp</span> <span class="n">x4</span><span class="p">,</span> <span class="n">x5</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span> <span class="p">,</span><span class="mi">16</span> <span class="o">*</span> <span class="mi">2</span><span class="p">]</span>
    <span class="n">stp</span> <span class="n">x6</span><span class="p">,</span> <span class="n">x7</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span> <span class="p">,</span><span class="mi">16</span> <span class="o">*</span> <span class="mi">3</span><span class="p">]</span>
    <span class="n">stp</span> <span class="n">x8</span><span class="p">,</span> <span class="n">x9</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span> <span class="p">,</span><span class="mi">16</span> <span class="o">*</span> <span class="mi">4</span><span class="p">]</span>
    <span class="n">stp</span> <span class="n">x10</span><span class="p">,</span> <span class="n">x11</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span> <span class="p">,</span><span class="mi">16</span> <span class="o">*</span> <span class="mi">5</span><span class="p">]</span>
    <span class="n">stp</span> <span class="n">x12</span><span class="p">,</span> <span class="n">x13</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span> <span class="p">,</span><span class="mi">16</span> <span class="o">*</span> <span class="mi">6</span><span class="p">]</span>
    <span class="n">stp</span> <span class="n">x14</span><span class="p">,</span> <span class="n">x15</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span> <span class="p">,</span><span class="mi">16</span> <span class="o">*</span> <span class="mi">7</span><span class="p">]</span>
    <span class="n">stp</span> <span class="n">x16</span><span class="p">,</span> <span class="n">x17</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span> <span class="p">,</span><span class="mi">16</span> <span class="o">*</span> <span class="mi">8</span><span class="p">]</span>
    <span class="n">stp</span> <span class="n">x18</span><span class="p">,</span> <span class="n">x19</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span> <span class="p">,</span><span class="mi">16</span> <span class="o">*</span> <span class="mi">9</span><span class="p">]</span>
    <span class="n">stp</span> <span class="n">x20</span><span class="p">,</span> <span class="n">x21</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span> <span class="p">,</span><span class="mi">16</span> <span class="o">*</span> <span class="mi">10</span><span class="p">]</span>
    <span class="n">stp</span> <span class="n">x22</span><span class="p">,</span> <span class="n">x23</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span> <span class="p">,</span><span class="mi">16</span> <span class="o">*</span> <span class="mi">11</span><span class="p">]</span>
    <span class="n">stp</span> <span class="n">x24</span><span class="p">,</span> <span class="n">x25</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span> <span class="p">,</span><span class="mi">16</span> <span class="o">*</span> <span class="mi">12</span><span class="p">]</span>
    <span class="n">stp</span> <span class="n">x26</span><span class="p">,</span> <span class="n">x27</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span> <span class="p">,</span><span class="mi">16</span> <span class="o">*</span> <span class="mi">13</span><span class="p">]</span>
    <span class="n">stp</span> <span class="n">x28</span><span class="p">,</span> <span class="n">x29</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span> <span class="p">,</span><span class="mi">16</span> <span class="o">*</span> <span class="mi">14</span><span class="p">]</span>
    <span class="n">str</span> <span class="n">x30</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="mi">16</span> <span class="o">*</span> <span class="mi">15</span><span class="p">]</span>
<span class="p">.</span><span class="n">endm</span>

<span class="c1">// load general registers from stack</span>
<span class="p">.</span><span class="n">macro</span> <span class="n">load_all</span>
    <span class="n">ldp</span> <span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span> <span class="p">,</span><span class="mi">16</span> <span class="o">*</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">ldp</span> <span class="n">x2</span><span class="p">,</span> <span class="n">x3</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span> <span class="p">,</span><span class="mi">16</span> <span class="o">*</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">ldp</span> <span class="n">x4</span><span class="p">,</span> <span class="n">x5</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span> <span class="p">,</span><span class="mi">16</span> <span class="o">*</span> <span class="mi">2</span><span class="p">]</span>
    <span class="n">ldp</span> <span class="n">x6</span><span class="p">,</span> <span class="n">x7</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span> <span class="p">,</span><span class="mi">16</span> <span class="o">*</span> <span class="mi">3</span><span class="p">]</span>
    <span class="n">ldp</span> <span class="n">x8</span><span class="p">,</span> <span class="n">x9</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span> <span class="p">,</span><span class="mi">16</span> <span class="o">*</span> <span class="mi">4</span><span class="p">]</span>
    <span class="n">ldp</span> <span class="n">x10</span><span class="p">,</span> <span class="n">x11</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span> <span class="p">,</span><span class="mi">16</span> <span class="o">*</span> <span class="mi">5</span><span class="p">]</span>
    <span class="n">ldp</span> <span class="n">x12</span><span class="p">,</span> <span class="n">x13</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span> <span class="p">,</span><span class="mi">16</span> <span class="o">*</span> <span class="mi">6</span><span class="p">]</span>
    <span class="n">ldp</span> <span class="n">x14</span><span class="p">,</span> <span class="n">x15</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span> <span class="p">,</span><span class="mi">16</span> <span class="o">*</span> <span class="mi">7</span><span class="p">]</span>
    <span class="n">ldp</span> <span class="n">x16</span><span class="p">,</span> <span class="n">x17</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span> <span class="p">,</span><span class="mi">16</span> <span class="o">*</span> <span class="mi">8</span><span class="p">]</span>
    <span class="n">ldp</span> <span class="n">x18</span><span class="p">,</span> <span class="n">x19</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span> <span class="p">,</span><span class="mi">16</span> <span class="o">*</span> <span class="mi">9</span><span class="p">]</span>
    <span class="n">ldp</span> <span class="n">x20</span><span class="p">,</span> <span class="n">x21</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span> <span class="p">,</span><span class="mi">16</span> <span class="o">*</span> <span class="mi">10</span><span class="p">]</span>
    <span class="n">ldp</span> <span class="n">x22</span><span class="p">,</span> <span class="n">x23</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span> <span class="p">,</span><span class="mi">16</span> <span class="o">*</span> <span class="mi">11</span><span class="p">]</span>
    <span class="n">ldp</span> <span class="n">x24</span><span class="p">,</span> <span class="n">x25</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span> <span class="p">,</span><span class="mi">16</span> <span class="o">*</span> <span class="mi">12</span><span class="p">]</span>
    <span class="n">ldp</span> <span class="n">x26</span><span class="p">,</span> <span class="n">x27</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span> <span class="p">,</span><span class="mi">16</span> <span class="o">*</span> <span class="mi">13</span><span class="p">]</span>
    <span class="n">ldp</span> <span class="n">x28</span><span class="p">,</span> <span class="n">x29</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span> <span class="p">,</span><span class="mi">16</span> <span class="o">*</span> <span class="mi">14</span><span class="p">]</span>
    <span class="n">ldr</span> <span class="n">x30</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="mi">16</span> <span class="o">*</span> <span class="mi">15</span><span class="p">]</span>
    <span class="n">add</span> <span class="n">sp</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="mi">32</span> <span class="o">*</span> <span class="mi">8</span>
<span class="p">.</span><span class="n">endm</span>

<span class="nl">exception_handler</span><span class="p">:</span>
    <span class="n">save_all</span>
    <span class="n">bl</span> <span class="n">exception_entry</span>
    <span class="n">load_all</span>
    <span class="n">eret</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">required</span> <span class="pre">1-4</span></code> Save the user program’s context before executing the exception handler.</p>
</div>
</div>
</div>
<div class="section" id="requirement-2">
<h3>Requirement 2<a class="headerlink" href="#requirement-2" title="Permalink to this headline">¶</a></h3>
<div class="section" id="core-timer-interrupt">
<h4>Core Timer Interrupt<a class="headerlink" href="#core-timer-interrupt" title="Permalink to this headline">¶</a></h4>
<p>Rpi3’s each CPU core has its core timer.
It can be configured by the following system registers.</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">cntpct_el0</span></code>: The timer’s current count.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cntp_cval_el0</span></code>: A compared timer count. If <code class="docutils literal notranslate"><span class="pre">cntpct_el0</span></code> &gt;= <code class="docutils literal notranslate"><span class="pre">cntp_cval_el0</span></code>, interrupt the CPU core.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cntp_tval_el0</span></code>: (<code class="docutils literal notranslate"><span class="pre">cntp_cval_el0</span></code> - <code class="docutils literal notranslate"><span class="pre">cntpct_el0</span></code>). You can use it to set an expired timer after the current timer count.</p></li>
</ul>
</div></blockquote>
<p>To enable the timer’s interrupt, you need to</p>
<ol class="arabic simple">
<li><p>set <code class="docutils literal notranslate"><span class="pre">cntp_ctl_el0</span></code> to 1.</p></li>
<li><p>unmask the timer interrupt from the first level interrupt controller.</p></li>
<li><p>you should enable the CPU core’s interrupt.</p></li>
</ol>
<p>In the required part, you only need to enable interrupt in EL0.
You can do it by setting <code class="docutils literal notranslate"><span class="pre">spsr_el1</span></code> to 0 before returning to EL0.</p>
<p>You can use the following code to enable the core timer’s interrupt.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#define CORE0_TIMER_IRQ_CTRL 0x40000040</span>

<span class="nl">core_timer_enable</span><span class="p">:</span>
  <span class="n">mov</span> <span class="n">x0</span><span class="p">,</span> <span class="mi">1</span>
  <span class="n">msr</span> <span class="n">cntp_ctl_el0</span><span class="p">,</span> <span class="n">x0</span> <span class="c1">// enable</span>
  <span class="n">mrs</span> <span class="n">x0</span><span class="p">,</span> <span class="n">cntfrq_el0</span>
  <span class="n">msr</span> <span class="n">cntp_tval_el0</span><span class="p">,</span> <span class="n">x0</span> <span class="c1">// set expired time</span>
  <span class="n">mov</span> <span class="n">x0</span><span class="p">,</span> <span class="mi">2</span>
  <span class="n">ldr</span> <span class="n">x1</span><span class="p">,</span> <span class="o">=</span><span class="n">CORE0_TIMER_IRQ_CTRL</span>
  <span class="n">str</span> <span class="n">w0</span><span class="p">,</span> <span class="p">[</span><span class="n">x1</span><span class="p">]</span> <span class="c1">// unmask timer interrupt</span>

<span class="nl">core_timer_handler</span><span class="p">:</span>
  <span class="n">mrs</span> <span class="n">x0</span><span class="p">,</span> <span class="n">cntfrq_el0</span>
  <span class="n">msr</span> <span class="n">cntp_tval_el0</span><span class="p">,</span> <span class="n">x0</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">required</span> <span class="pre">2</span></code> Enable the core timer’s interrupt. The interrupt handler should print the seconds after booting and set the next timeout to 2 seconds later.</p>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>You can get the seconds after booting from the count of the timer(<code class="docutils literal notranslate"><span class="pre">cntpct_el0</span></code>) and the frequency of the timer(<code class="docutils literal notranslate"><span class="pre">cntfrq_el0</span></code>).</p>
</div>
</div>
</div>
</div>
<div class="section" id="elective">
<h2>Elective<a class="headerlink" href="#elective" title="Permalink to this headline">¶</a></h2>
<div class="section" id="enable-interrupt-in-el1">
<h3>Enable Interrupt in EL1<a class="headerlink" href="#enable-interrupt-in-el1" title="Permalink to this headline">¶</a></h3>
<p>In the elective part, it’s required to enable interrupts in EL1.
You can only disable interrupts to protect the critical sections.
You can use the following code to enable/disable interrupts.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">// enable interrupt</span>
<span class="n">msr</span> <span class="n">DAIFClr</span><span class="p">,</span> <span class="mh">0xf</span>
<span class="c1">// disable interrupt</span>
<span class="n">msr</span> <span class="n">DAIFSet</span><span class="p">,</span> <span class="mh">0xf</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This part is the dependency of the following elective parts, but it doesn’t count in your score.</p>
</div>
</div>
<div class="section" id="rpi3-s-peripheral-interrupt">
<h3>Rpi3’s Peripheral Interrupt<a class="headerlink" href="#rpi3-s-peripheral-interrupt" title="Permalink to this headline">¶</a></h3>
<p>In this elective part, you need to implement rpi3’s mini UART’s interrupt handling.
Then, you don’t have to busy polling the UART device.</p>
<div class="section" id="enable-mini-uart-s-interrupt">
<h4>Enable mini UART’s Interrupt.<a class="headerlink" href="#enable-mini-uart-s-interrupt" title="Permalink to this headline">¶</a></h4>
<p>To enable mini UART’s interrupt,
you need to set <code class="docutils literal notranslate"><span class="pre">AUX_MU_IER_REG(0x3f215044)</span></code> and the second level interrupt controller’s <code class="docutils literal notranslate"><span class="pre">Enable</span> <span class="pre">IRQs1(0x3f00b210)</span></code>’s  bit29.</p>
</div>
<div class="section" id="determine-the-interrupt-source">
<h4>Determine the Interrupt Source<a class="headerlink" href="#determine-the-interrupt-source" title="Permalink to this headline">¶</a></h4>
<p>When the UART’s interrupt is enabled, there is more than one interrupt source to the CPU.
Hence, your kernel needs to check the source of the interrupt before executing the corresponding interrupt handler.
Please refer to both interrupt controllers’ manuals to determine the interrupt source.</p>
</div>
<div class="section" id="asynchronous-read-and-write">
<h4>Asynchronous Read and Write<a class="headerlink" href="#asynchronous-read-and-write" title="Permalink to this headline">¶</a></h4>
<p>In previous labs, your shell blocks the execution by busy polling the UART when it needs to read or write.
Now, you can create a read buffer and a write buffer.
Your shell writes bytes to the write buffer when it prints a message.
The data is sent asynchronously by the UART’s TX interrupt handler.
Also, the UART’s RX interrupt handler put data in the read buffer.
The shell reads bytes array from the buffer and gets the number of bytes it read.</p>
<p><code class="docutils literal notranslate"><span class="pre">elective</span> <span class="pre">1</span></code> Implement the asynchronous UART read/write by interrupt handlers.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You don’t have to replace all print functions to the asynchronous version.</p>
</div>
</div>
</div>
<div class="section" id="timer-multiplexing">
<h3>Timer Multiplexing<a class="headerlink" href="#timer-multiplexing" title="Permalink to this headline">¶</a></h3>
<p>Timers can be used to do periodic jobs such as scheduling and journaling and one-shot executing such as sleeping and timeout.
However, the number of the hardware timer is limited.
Therefore, the kernel needs a software mechanism to multiplex the timer.</p>
<p>One simple way is using a periodic timer.
The kernel can use the tick period as the time unit and calculate the corresponding timeout tick.
For example, suppose the periodic timer’s frequency is 1000HZ and a process sleeps for 1.5 seconds.
The kernel can add a wake-up event at the moment that 1500 ticks after the current tick.</p>
<p>However, when the tick frequency is too low, the timer has a bad resolution.
Then, it can’t be used for time-sensitive jobs.
When the tick frequency is too high, it introduces a lot of overhead for redundant timer interrupt handling.</p>
<p>Another way is using a one-shot timer.
When someone needs a timeout event, a timer is inserted into a timer queue.
If the timeout is earlier than the previous programed expired time, the kernel reprograms the hardware timer to the earlier one.
In the timer interrupt handler, it executes the expired timer’s callback function.</p>
<p>In this elective part, you need to implement the timer API that a user can register the callback function when the
timeout using the one-shot timer(the core timer is a one-shot timer).
The API and its use case should look like the below pseudo code.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># An example API</span>
<span class="k">def</span> <span class="nf">add_timer</span><span class="p">(</span><span class="n">callback</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">after</span><span class="p">):</span>
    <span class="o">...</span>

<span class="c1"># An example use case</span>
<span class="k">def</span> <span class="nf">sleep</span><span class="p">(</span><span class="n">duration</span><span class="p">):</span>
    <span class="n">add_timer</span><span class="p">(</span><span class="n">wakeup</span><span class="p">(</span><span class="n">current_process</span><span class="p">),</span> <span class="n">duration</span><span class="p">)</span>
</pre></div>
</div>
<p>To test the API, you need to implement the shell command <code class="docutils literal notranslate"><span class="pre">setTimeout</span> <span class="pre">MESSAGE</span> <span class="pre">SECONDS</span></code>.
It prints MESSAGE after SECONDS with the current time and the command executed time.</p>
<p><code class="docutils literal notranslate"><span class="pre">elective</span> <span class="pre">2</span></code> Implement the <code class="docutils literal notranslate"><span class="pre">setTimeout</span></code> command with the timer API.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code class="docutils literal notranslate"><span class="pre">setTimeout</span></code> is non-blocking. Users can set multiple timeouts.
The printing order is determined by the command executed time and the user specified SECONDS.</p>
</div>
</div>
<div class="section" id="concurrent-i-o-devices-handling">
<h3>Concurrent I/O Devices Handling<a class="headerlink" href="#concurrent-i-o-devices-handling" title="Permalink to this headline">¶</a></h3>
<p>The kernel needs to handle a lot of I/O devices at the same time.
For devices(e.g. UART) that have a short period of process time,
the kernel can finish their handlers immediately right after they’re ready.
However, for those devices(e.g. network interface controller) that require a longer time for the follow-up processing,
the kernel needs to schedule the execution order.</p>
<p>Usually, we want to use the first come first serve principle to prevent starvation.
However, we may also want prioritized execution for some critical handlers.
In this part, you need to know how to implement it using a single thread(i.e. a single stack).</p>
<div class="section" id="decouple-the-interrupt-handlers">
<h4>Decouple the Interrupt Handlers<a class="headerlink" href="#decouple-the-interrupt-handlers" title="Permalink to this headline">¶</a></h4>
<p>A simpler way to implement an interrupt handler is processing all the device’s data one at a time with interrupts disabled.
However, a less critical interrupt handler can block a more critical one for a long time.
Hence, we want to decouple the interrupt handler and the actual processing.</p>
<p>This can be achieved by a task queue.
In the interrupt handler, the kernel</p>
<ol class="arabic simple">
<li><p>masks the device’s interrupt line,</p></li>
<li><p>move data from the device’s buffer through DMA, or manually copy,</p></li>
<li><p>enqueues the processing task to the event queue,</p></li>
<li><p>does the tasks with interrupts enabled,</p></li>
<li><p>unmasks the interrupt line to get the next interrupt at the end of the task.</p></li>
</ol>
<p>Those tasks in the queue can be processed when the system is idle.
Also, the kernel can execute the task in any order such as FIFO or LIFO.</p>
<p><code class="docutils literal notranslate"><span class="pre">elective</span> <span class="pre">3-1</span></code> Implement a task queue mechanism, so interrupt handlers can add its processing tasks to it.</p>
</div>
<div class="section" id="nested-interrupt">
<h4>Nested Interrupt<a class="headerlink" href="#nested-interrupt" title="Permalink to this headline">¶</a></h4>
<p>The tasks in the queue can be executed at any time, but we want them to be executed as soon as possible.
It’s because that a high-priority process may be waiting for the data.</p>
<p>Therefore, before the interrupt handler return to the user program,
it should execute the tasks in the interrupt context with interrupts enabled (otherwise, critical interrupts are blocked).
Then, the interrupt handler may be nested.
Hence, besides general-purpose registers, you should also save <code class="docutils literal notranslate"><span class="pre">spsr_el1</span></code> and <code class="docutils literal notranslate"><span class="pre">elr_el1</span></code> so the previous saved data are preserved.</p>
<p><code class="docutils literal notranslate"><span class="pre">elective</span> <span class="pre">3-2</span></code> Execute the tasks in the queue before returning to the user program with interrupts enabled.</p>
</div>
<div class="section" id="preemption">
<h4>Preemption<a class="headerlink" href="#preemption" title="Permalink to this headline">¶</a></h4>
<p>Now, any interrupt handler can preempt the task’s execution, but the newly enqueued task still needs to wait for
the currently running task’s completion.
It’d be better if the newly enqueued task with a higher priority can preempt the currently running task.</p>
<p>To achieve the preemption,
the kernel can check the last executing task’s priority before returning to the previous interrupt handler.
If there are higher priority tasks, execute the highest priority task.</p>
<p><code class="docutils literal notranslate"><span class="pre">elective</span> <span class="pre">3-3</span></code> Implement the task queue’s preemption mechanism.</p>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="../hardware/asm.html" class="btn btn-neutral float-right" title="The Assembly You Need" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="lab3.html" class="btn btn-neutral float-left" title="Lab 3: Allocator" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, Jim.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>