

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Lab 0: Environment Setup &mdash; nycuos 0.0 documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Lab 1: Hello World" href="lab1.html" />
    <link rel="prev" title="NYCU, Operating System Capstone, Spring 2021" href="../index.html" />
 
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-QNCCQQWJ9J"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-QNCCQQWJ9J');
</script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> nycuos
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Labs</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Lab 0: Environment Setup</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#introduction">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="#goals">Goals</a></li>
<li class="toctree-l2"><a class="reference internal" href="#cross-platform-development">Cross-Platform Development</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#cross-compiler">Cross Compiler</a></li>
<li class="toctree-l3"><a class="reference internal" href="#linker">Linker</a></li>
<li class="toctree-l3"><a class="reference internal" href="#qemu">QEMU</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#from-source-code-to-kernel-image">From Source Code to Kernel Image</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#from-source-code-to-object-files">From Source Code to Object Files</a></li>
<li class="toctree-l3"><a class="reference internal" href="#from-object-files-to-elf">From Object Files to ELF</a></li>
<li class="toctree-l3"><a class="reference internal" href="#from-elf-to-kernel-image">From ELF to Kernel Image</a></li>
<li class="toctree-l3"><a class="reference internal" href="#check-on-qemu">Check on QEMU</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#deploy-to-real-rpi3">Deploy to REAL Rpi3</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#flash-bootable-image-to-sd-card">Flash Bootable Image to SD Card</a></li>
<li class="toctree-l3"><a class="reference internal" href="#interact-with-rpi3">Interact with Rpi3</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#debugging">Debugging</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#debug-on-qemu">Debug on QEMU</a></li>
<li class="toctree-l3"><a class="reference internal" href="#debug-on-real-rpi3">Debug on Real Rpi3</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="lab1.html">Lab 1: Hello World</a></li>
<li class="toctree-l1"><a class="reference internal" href="lab2.html">Lab 2: Booting</a></li>
<li class="toctree-l1"><a class="reference internal" href="lab3.html">Lab 3: Allocator</a></li>
<li class="toctree-l1"><a class="reference internal" href="lab4.html">Lab 4: Exception and Interrupt</a></li>
<li class="toctree-l1"><a class="reference internal" href="lab5.html">Lab 5: Thread and User Process</a></li>
<li class="toctree-l1"><a class="reference internal" href="lab6.html">Lab 6 : Virtual File System</a></li>
<li class="toctree-l1"><a class="reference internal" href="lab7.html">Lab 7 : File System Meets Hardware</a></li>
<li class="toctree-l1"><a class="reference internal" href="lab8.html">Lab 8 : Virtual Memory</a></li>
</ul>
<p class="caption"><span class="caption-text">Hardware</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../hardware/asm.html">The Assembly You Need</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hardware/uart.html">UART</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hardware/mailbox.html">Mailbox</a></li>
</ul>
<p class="caption"><span class="caption-text">Miscs</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../external_reference/index.html">External Reference</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">nycuos</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Lab 0: Environment Setup</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/labs/lab0.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="lab-0-environment-setup">
<h1>Lab 0: Environment Setup<a class="headerlink" href="#lab-0-environment-setup" title="Permalink to this headline">¶</a></h1>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>In Lab 0, you need to prepare the environment for future development.
You should install the target toolchain, and use them to build a bootable image for rpi3.</p>
</div>
<div class="section" id="goals">
<h2>Goals<a class="headerlink" href="#goals" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Set up the development environment.</p></li>
<li><p>Understand what’s cross-platform development.</p></li>
<li><p>Test your rpi3.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This lab is an introductory lab.
It won’t be part of your final grade, but you still need to finish all <code class="docutils literal notranslate"><span class="pre">required</span></code> parts,
or you’ll be in trouble in the next lab.</p>
</div>
</div>
<div class="section" id="cross-platform-development">
<h2>Cross-Platform Development<a class="headerlink" href="#cross-platform-development" title="Permalink to this headline">¶</a></h2>
<div class="section" id="cross-compiler">
<h3>Cross Compiler<a class="headerlink" href="#cross-compiler" title="Permalink to this headline">¶</a></h3>
<p>Rpi3 uses ARM Cortex-A53 CPU.
To compile your source code to 64-bit ARM machine code, you need a cross compiler if you develop
on non-ARM64 environment.</p>
<p><code class="docutils literal notranslate"><span class="pre">required</span></code> Install a cross compiler on your host computer.</p>
</div>
<div class="section" id="linker">
<h3>Linker<a class="headerlink" href="#linker" title="Permalink to this headline">¶</a></h3>
<p>You might not notice the existence of linkers before.
It’s because the compiler uses the default linker script for you. (<code class="docutils literal notranslate"><span class="pre">ld</span> <span class="pre">--verbose</span></code> to check the content)
In bare metal programming, you should set the memory layout yourself.</p>
<p>This is an incomplete linker script for you.
You should extend it in the following lab.</p>
<div class="highlight-none notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span>SECTIONS
{
  . = 0x80000;
  .text : { *(.text) }
}
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="qemu">
<h3>QEMU<a class="headerlink" href="#qemu" title="Permalink to this headline">¶</a></h3>
<p>In cross-platform development,
it’s easier to validate your code on an emulator first.
You can use QEMU to test your code first before validating them on a real rpi3.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Although QEMU provides a machine option for rpi3, it doesn’t behave the same as a real rpi3.
You should validate your code on your rpi3, too.</p>
</div>
<p><code class="docutils literal notranslate"><span class="pre">required</span></code> Install <code class="docutils literal notranslate"><span class="pre">qemu-system-aarch64</span></code>.</p>
</div>
</div>
<div class="section" id="from-source-code-to-kernel-image">
<h2>From Source Code to Kernel Image<a class="headerlink" href="#from-source-code-to-kernel-image" title="Permalink to this headline">¶</a></h2>
<p>You have the basic knowledge of the toolchain for cross-platform development. Now, it’s time to practice them.</p>
<div class="section" id="from-source-code-to-object-files">
<h3>From Source Code to Object Files<a class="headerlink" href="#from-source-code-to-object-files" title="Permalink to this headline">¶</a></h3>
<p>Source code is converted to object files by cross compiler.
After saving the following assembly as <code class="docutils literal notranslate"><span class="pre">a.S</span></code>,
you can convert it to an object file by <code class="docutils literal notranslate"><span class="pre">aarch64-linux-gnu-gcc</span> <span class="pre">-c</span> <span class="pre">a.S</span></code>.
Or if you would like to, you can also try llvm’s linker <code class="docutils literal notranslate"><span class="pre">clang</span> <span class="pre">-mcpu=cortex-a53</span> <span class="pre">--target=aarch64-rpi3-elf</span> <span class="pre">-c</span> <span class="pre">a.S</span></code>,
especially if you are trying to develop on macOS.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="p">.</span><span class="n">section</span> <span class="s">&quot;.text&quot;</span>
<span class="nl">_start</span><span class="p">:</span>
  <span class="n">wfe</span>
  <span class="n">b</span> <span class="n">_start</span>
</pre></div>
</div>
</div>
<div class="section" id="from-object-files-to-elf">
<h3>From Object Files to ELF<a class="headerlink" href="#from-object-files-to-elf" title="Permalink to this headline">¶</a></h3>
<p>A linker links object files to an ELF file.
An ELF file can be loaded and executed by program loaders.
Program loaders are usually provided by the operating system in regular development environment.
In bare metal programming, ELF can be loaded by some bootloaders.</p>
<p>To convert the object file from previous step to an ELF file,
you can save the provided linker script as <code class="docutils literal notranslate"><span class="pre">linker.ld</span></code>, and run the following command.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># On GNU LD
aarch64-linux-gnu-ld -T linker.ld -o kernel8.elf a.o
# On LLVM
ld.lld -m aarch64elf -T linker.ld -o kernel8.elf a.o
</pre></div>
</div>
</div>
<div class="section" id="from-elf-to-kernel-image">
<h3>From ELF to Kernel Image<a class="headerlink" href="#from-elf-to-kernel-image" title="Permalink to this headline">¶</a></h3>
<p>Rpi3’s bootloader can’t load ELF files.
Hence, you need to convert the ELF file to a raw binary image.
You can use <code class="docutils literal notranslate"><span class="pre">objcopy</span></code> to convert ELF files to raw binary.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>aarch64-linux-gnu-objcopy -O binary kernel8.elf kernel8.img
# Or
llvm-objcopy --output-target=aarch64-rpi3-elf -O binary kernel8.elf kernle8.img
</pre></div>
</div>
</div>
<div class="section" id="check-on-qemu">
<h3>Check on QEMU<a class="headerlink" href="#check-on-qemu" title="Permalink to this headline">¶</a></h3>
<p>After building, you can use QEMU to see the dumped assembly.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>qemu-system-aarch64 -M raspi3 -kernel kernel8.img -display none -d in_asm
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">required</span></code> Build your first kernel image, and check it on QEMU.</p>
</div>
</div>
<div class="section" id="deploy-to-real-rpi3">
<h2>Deploy to REAL Rpi3<a class="headerlink" href="#deploy-to-real-rpi3" title="Permalink to this headline">¶</a></h2>
<div class="section" id="flash-bootable-image-to-sd-card">
<h3>Flash Bootable Image to SD Card<a class="headerlink" href="#flash-bootable-image-to-sd-card" title="Permalink to this headline">¶</a></h3>
<p>To prepare a bootable image for rpi3, you have to prepare at least the following stuff.</p>
<ul class="simple">
<li><p>An FAT16/32 partition contains</p>
<ul>
<li><p>Firmware for GPU.</p></li>
<li><p>Kernel image.(kernel8.img)</p></li>
</ul>
</li>
</ul>
<p>There are two ways to do it.</p>
<ol class="arabic">
<li><p>We already prepared a <a class="reference external" href="https://github.com/GrassLab/osdi/raw/master/supplement/nctuos.img">bootable image</a>.
You can use the following command to flash it to your SD card.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>dd if=nctuos.img of=/dev/sdb
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>/dev/sdb should be replaced by your SD card device. You can check it by <cite>lsblk</cite></p>
</div>
<p>It’s already partition and contains an FAT32 filesystem with firmware inside.
You can mount the partition to check.</p>
</li>
<li><p>Partition the disk and prepare the booting firmware yourself.
You can download the firmware from
<a class="reference external" href="https://github.com/raspberrypi/firmware/tree/master/boot">https://github.com/raspberrypi/firmware/tree/master/boot</a></p>
<p>bootcode.bin, fixup.dat and start.elf are essentials.
More information about pi3’s booting could be checked on official website
<a class="reference external" href="https://www.raspberrypi.org/documentation/configuration/boot_folder.md">https://www.raspberrypi.org/documentation/configuration/boot_folder.md</a>
<a class="reference external" href="https://www.raspberrypi.org/documentation/hardware/raspberrypi/bootmodes/README.md">https://www.raspberrypi.org/documentation/hardware/raspberrypi/bootmodes/README.md</a></p>
<p>Finally, put the firmware and your kernel image into the FAT partition.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Besides using <code class="docutils literal notranslate"><span class="pre">mkfs.fat</span> <span class="pre">-F</span> <span class="pre">32</span></code> to create an FAT32 filesystem, you should also set the partition type to FAT.</p>
</div>
</li>
</ol>
<p><code class="docutils literal notranslate"><span class="pre">required</span></code> Use either one of the methods to set up your SD card.</p>
</div>
<div class="section" id="interact-with-rpi3">
<h3>Interact with Rpi3<a class="headerlink" href="#interact-with-rpi3" title="Permalink to this headline">¶</a></h3>
<p>In our provided bootable image, it contains a kernel image can echoes what you type through UART.
You can use it to test if your Lab kits function well.</p>
<p>1. If you use method 2 to set up your bootable image, you should download <a class="reference external" href="https://github.com/GrassLab/osdi/raw/master/supplement/kernel8.img">kernel8.img</a>
, and put it into your boot partition. It’s identical to the one in the provided bootable image.</p>
<ol class="arabic simple" start="2">
<li><p>Plug in the UART to USB converter to your host machine, and open it through serial console such as screen or putty with correct baud rate.</p></li>
<li><p>Connect TX, RX, GND to the corresponding pins on rpi3, and turn on your rpi3.</p></li>
<li><p>After your rpi3 powers on, you can type some letters, and your serial console should print what you just typed.</p></li>
</ol>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>screen /dev/ttyUSB0 115200
</pre></div>
</div>
</div>
</div>
<div class="section" id="debugging">
<h2>Debugging<a class="headerlink" href="#debugging" title="Permalink to this headline">¶</a></h2>
<div class="section" id="debug-on-qemu">
<h3>Debug on QEMU<a class="headerlink" href="#debug-on-qemu" title="Permalink to this headline">¶</a></h3>
<p>Debugging on QEMU is a relatively easier way to validate your code.
QEMU could dump memory, registers, and expose them to a debugger.
You can use the following command waiting for gdb connection.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>qemu-system-aarch64 -M raspi3 -kernel kernel8.img -display none -S -s
</pre></div>
</div>
<p>Then you can use the following command in gdb to load debugging information and connect to QEMU.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>file kernel8.elf
target remote :1234
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Your gdb should also be cross-platform gdb.</p>
</div>
</div>
<div class="section" id="debug-on-real-rpi3">
<h3>Debug on Real Rpi3<a class="headerlink" href="#debug-on-real-rpi3" title="Permalink to this headline">¶</a></h3>
<p>You could either use print log or JTAG to debug on a real rpi3.
We don’t provide JTAG in this course, you can try it if you have one.
<a class="reference external" href="https://metebalci.com/blog/bare-metal-raspberry-pi-3b-jtag/">https://metebalci.com/blog/bare-metal-raspberry-pi-3b-jtag/</a></p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="lab1.html" class="btn btn-neutral float-right" title="Lab 1: Hello World" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="../index.html" class="btn btn-neutral float-left" title="NYCU, Operating System Capstone, Spring 2021" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, Jim.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>